<!DOCTYPE html>

<html lang="it" ng-app="thingsAngular">
<head>
    <meta charset="utf-8" />
    <title>Things Console with FreeAnts Angular SDK</title>
    <!-- Base Libraries -->
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/angular-translate/angular-translate.min.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/signalr/jquery.signalR.min.js"></script>

    // Must be the First
    <script src="src/module.js"></script>

	<script src="src/account.datacontext.js"></script>
    <script src="src/accountManager.js"></script>
    <script src="src/asyncLoader.js"></script>
    <script src="src/constants.js"></script>
    <script src="src/helpers.js"></script>
    <script src="src/localizator.js"></script>
    <script src="src/login.datacontext.js"></script>
    <script src="src/notifiersConnector.js"></script>
    <script src="src/pushNotifications.datacontext.js"></script>
    <script src="src/thing.datacontext.js"></script>
    <script src="src/thingmodel.js"></script>
    <script src="src/things.manager.js"></script>
    <script src="src/thingUserRights.datacontext.js"></script>
    <script src="src/translationService.js"></script>
    <script src="src/user.datacontext.js"></script>
    
    <script>
        'use strict'

        var app = angular.module('thingsAngular', ['freeants']);

        app.constant("path", {
            server: "http://titaggocoreportal.azurewebsites.net/",
            api: "http://titaggocoreportal.azurewebsites.net/api"
        });

        app.config(['accountManagerProvider',
            function (accountManagerProvider) {

                accountManagerProvider.setAppName("thingsAngular");
                accountManagerProvider.setStorage(localStorage, "AccessTokenOrDWApiKey");
                accountManagerProvider.setApiKey("6fce33cc-2e21-4669-9000-dc2b5bc9cc99");

        }]);

        app.run([ 'path', 'accountManagerService', 'notifierConnector', 
            function (path, accountManagerService, notifierConnector) {

                //Initialize SignalR
               function connectionStatus(change) {
                   switch (change.newState) {
                       case notifierConnector.connected:
                           {
                               console.log("connected");
                               break;
                           }
                       case notifierConnector.connecting:
                           {
                               console.log("connecting");
                               break;
                           }
                       case notifierConnector.reconnecting:
                           {
                               console.log("reconnecting");
                               break;
                           }
                       case notifierConnector.disconnected:
                       default:
                           {
                               console.log("disconnected");
                               break;
                           }
                   }
               }
               function onReconnected() {
                   console.log("OnReconnected");
               };

               notifierConnector.init(connectionStatus, onReconnected);

               notifierConnector.setHook('onCreateThing', function (thing) {
                   console.log('OnCreateThing');
               });
               notifierConnector.setHook('onCreateChildThingId', function (parentThingId, childThingId, kind) {
                   console.log('onCreateChildThingId');
               });
               notifierConnector.setHook('onUpdateThingValue', function (thingId, value) {
                   console.log('onUpdateThingValue 1');
               });
               notifierConnector.setHook('onDeleteChildThingId', function (parentThingId, childThingId, kind) {
                   console.log('onDeleteChildThingId');
               });

               function subscribeSuccess() {
                   console.log('SignalR Subscribe Success');
               }
               function subscribeFail() {
                   console.log('SignalR Subscribe Failed');
               }
               notifierConnector.subscribe(path.server + "signalr", "DWApiKey", accountManagerService.getApiKey, subscribeSuccess, subscribeFail);
        }]);

        app.factory('AppsManager', ['$q', 'thingsManager', 'ThingModel',  'notifierConnector', function ($q, thingsManager, ThingModel, notifierConnector) {
        
            function AppsManager() {

                var self = this;

                this.mainThing = new ThingModel();
                this.apps = this.mainThing.children;

                this.getAppsParams = {			
                    //parentThingId: null,
                    filter: "Name eq 'favorite'",
                    top: 2,
                    //skip: 0,
                    orderBy: null,
                    valueFilter: null
                };
                this.getServicesParams = {
                        parentThingId: null,
                        filter: null,
                        top: 3,
                        skip: 0,
                        orderBy: null,
                        valueFilter: null
                    };

                this.onCreateThing = function onCreateThing(thing) {
                }
                this.onDeleteChildThingId = function onDeleteChildThingId(parentThingId, childThingId, kind) {
                }
                this.onUpdateThingValue = function onUpdateThingValue(thingId, value) {
                }

                notifierConnector.setHook('onCreateThing', function (thing) {
                    self.onCreateThing(thing);
                });
                notifierConnector.setHook('onDeleteChildThingId', function (parentThingId, childThingId, kind) {
                    self.onDeleteChildThingId(parentThingId, childThingId, kind);
                });
                notifierConnector.setHook('onUpdateThingValue', function (thingId, value) {
                    self.onUpdateThingValue(thingId, value);
                });
            }

            //AppsManager.prototype.mainThing = new ThingModel();

            AppsManager.prototype.getMoreAppsServices = function getMoreAppsServices(app, cancel) {
                return thingsManager.elapseThing(app, this.getServicesParams, cancel)
            }
            
            AppsManager.prototype.getMoreApps = function getMoreApps(cancel) {
                
                var self = this;

                var def = $q.defer();
                                
                thingsManager.elapseThing(this.mainThing, this.getAppsParams, cancel)
                .then(function (data) {
                    var promises = [];

                    // Try to get all things children
                    for (var i = 0; i < data.things.length; i++) {
                        promises.push(self.getMoreAppsServices(data.things[i], cancel));
                    }

                    $q.all(promises)
                    .then(function () {
                        def.resolve();
                    }, function (data) {
                        if (cancel)
                            cancel.resolve();
                        def.reject(data);
                    });
                });

                return def.promise;
            }

            return AppsManager;

        }]);
        // Define the `ThingsListController` controller
        app.controller('ThingsListController', ['$q', '$scope', 'AppsManager', function ThingsListController($q, $scope, AppsManager) {

            var appsManager = new AppsManager();

            var abortHttpCalls = $q.defer();
            
            $scope.apps = appsManager.apps;

            appsManager.getMoreApps(abortHttpCalls).then(function() {                
                appsManager.getMoreAppsServices($scope.apps[0], abortHttpCalls);
            });           
        }]);

        app.controller('PushNotificationCtrl', ['$scope', 'pushNotificationsDataContext', function ThingsListController($scope, pushNotificationsDataContext) {
            $scope.checkboxLanguage = {
                it: false,
                en: false,
                de: false
            };
            $scope.checkboxPlatforms = {
                gcm: false,
                apns: false
            };
            
            //ThingId Azure PushNotificationHUB
            $scope.hubId = "";
            
            //Local Messages
            $scope.localMessages = [];
            $scope.addRemoveMessage = function(value){
                
                var indexFound;
               
                for(var i=0; i < $scope.localMessages.length; i++){
                    if($scope.localMessages[i].culture == value)
                        indexFound = i;
                }
                
                if(indexFound !=undefined)
                   $scope.localMessages.splice(indexFound, 1);     

                else 
                    $scope.localMessages.push({title: "", message: "", culture: value});     
            };
            
            //Platforms
            $scope.platforms = [];
            $scope.addRemovePlatform = function(value){
                
                var indexFound;
               
                for(var i=0; i < $scope.platforms.length; i++){
                    if($scope.platforms[i] == value)
                        indexFound = i;
                }
                
                if(indexFound !=undefined)
                   $scope.platforms.splice(indexFound, 1);     
                else 
                    $scope.platforms.push(value);     
                    
            };
            
            //Send Push Notification
            $scope.SendPushNotification = function(){
                var pushModel = {
                    pns: $scope.platforms,
                    thingId: $scope.hubId,
                    localMessages : $scope.localMessages
                };
                
                pushNotificationsDataContext.push(pushModel)
                .then(function(data){
                    console.log(data);
                }, function(error){
                    console.log(error);
                })
            }
            
        }]);
    </script>

</head>
<body>
	<div>
		// Bravo!
	</div>
    
    <div ng-controller="ThingsListController">
        <ul>
            <li ng-repeat="app in apps">
                <span>{{app.id}}</span> - 
                <span>{{app.name}}</span>
                <ul>
                    <li ng-repeat="child in app.children">
                        <span>{{child.name}}</span>
                    </li>
                </ul>
            </li>
        </ul>
    </div>

    <div ng-controller="PushNotificationCtrl">
        <h3>Test send</h3>
        <input type="text" ng-model="hubId" placeholder="ThingHub ID">
        <br>
          <p>Platforms:</p><hr>
        <label>Google:
            <input type="checkbox" ng-model="checkboxPlatforms.gcm" ng-change="addRemovePlatform('gcm')">
        </label>
        <label>Apple:
            <input type="checkbox" ng-model="checkboxPlatforms.apns" ng-change="addRemovePlatform('apns')">
        </label><br><br>
        <p>Languages:</p><hr>
        <label>IT:
            <input type="checkbox" ng-model="checkboxLanguage.it" ng-change="addRemoveMessage('IT')">
        </label>
        <label>EN:
            <input type="checkbox" ng-model="checkboxLanguage.en" ng-change="addRemoveMessage('EN')">
        </label>
        <label>DE:
            <input type="checkbox" ng-model="checkboxLanguage.de" ng-change="addRemoveMessage('DE')">
        </label><br/><br />
        <div ng-repeat="localMessage in localMessages">
            <p>Add message for {{localMessage.culture}}</p>
            <input type="text" ng-model="localMessage.culture" hidden/>
            <input type="text" placeholder="Title {{localMessage.culture}}" ng-model="localMessage.title" />
            <input type="text" placeholder="Message {{localMessage.culture}}" ng-model="localMessage.message" />
            <hr>
        </div>
        <button ng-click="SendPushNotification()">Send</button><br>
        <code>
            {{platforms}}
        </code>
        <br>
        <code>
            {{localMessages}}
        </code>
        
    </div>
</body>
</html>