<!DOCTYPE html>

<html lang="it" ng-app="thingsAngular">
<head>
    <meta charset="utf-8" />
    <title>Things Console with FreeAnts Angular SDK</title>
    <!-- Base Libraries -->
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/angular-translate/angular-translate.min.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/signalr/jquery.signalR.min.js"></script>

    // Must be the First
    <script src="src/module.js"></script>

	<script src="src/account.datacontext.js"></script>
    <script src="src/accountManager.js"></script>
    <script src="src/asyncLoader.js"></script>
    <script src="src/constants.js"></script>
    <script src="src/helpers.js"></script>
    <script src="src/localizator.js"></script>
    <script src="src/login.datacontext.js"></script>
    <script src="src/notifiersConnector.js"></script>
    <script src="src/pushNotifications.datacontext.js"></script>
    <script src="src/scheduler.datacontext.js"></script>
    <script src="src/thing.datacontext.js"></script>
    <script src="src/thingmodel.js"></script>
    <script src="src/things.manager.js"></script>
    <script src="src/thingUserRights.datacontext.js"></script>
    <script src="src/translationService.js"></script>
    <script src="src/user.datacontext.js"></script>
    
    <script>
        'use strict'

        var app = angular.module('thingsAngular', ['freeants']);

        app.constant("path", {
            server: "http://titaggocoreportal.azurewebsites.net/",
            api: "http://titaggocoreportal.azurewebsites.net/api"
        });

        app.config(['accountManagerProvider',
            function (accountManagerProvider) {

                accountManagerProvider.setAppName("thingsAngular");
                accountManagerProvider.setStorage(localStorage, "AccessTokenOrDWApiKey");
                accountManagerProvider.setApiKey("Set ApiKey");

        }]);

        app.run(['$http', '$rootScope', 'notifierConnector', 'path', 'thingsDataContext', 'thingUserRightsDataContext', 'ThingsManager', 'accountManagerService',
            function ($http, $rootScope, notifierConnector, path, thingsDataContext, thingUserRightsDataContext, ThingsManager, accountManagerService) {

                //Initialize SignalR
               function connectionStatus(change) {
                   switch (change.newState) {
                       case notifierConnector.connected:
                           {
                               console.log("connected");
                               break;
                           }
                       case notifierConnector.connecting:
                           {
                               console.log("connecting");
                               break;
                           }
                       case notifierConnector.reconnecting:
                           {
                               console.log("reconnecting");
                               break;
                           }
                       case notifierConnector.disconnected:
                       default:
                           {
                               console.log("disconnected");
                               break;
                           }
                   }
               }
               function onReconnected() {
                   console.log("OnReconnected");
               };

               notifierConnector.init(connectionStatus, onReconnected);

               notifierConnector.setHook('onCreateThing', function (thing) {
                   console.log('OnCreateThing');
               });
               notifierConnector.setHook('onCreateChildThingId', function (parentThingId, childThingId, kind) {
                   console.log('onCreateChildThingId');
               });
               notifierConnector.setHook('onUpdateThingValue', function (thingId, value) {
                   console.log('onUpdateThingValue 1');
               });
               notifierConnector.setHook('onDeleteChildThingId', function (parentThingId, childThingId, kind) {
                   console.log('onDeleteChildThingId');
               });

               function subscribeSuccess() {
                   console.log('SignalR Subscribe Success');
               }
               function subscribeFail() {
                   console.log('SignalR Subscribe Failed');
               }
               notifierConnector.subscribe(path.server + "signalr", "DWApiKey", accountManagerService.getApiKey, subscribeSuccess, subscribeFail);
        }]);

        app.factory('appsManager', ['$q', 'thingsManager', 'ThingModel',  'notifierConnector', function ($q, thingsManager, ThingModel, notifierConnector) {

            var mainThing = new ThingModel();

            var getAppsParams = {			
                    //parentThingId: null,
                    filter: "Name eq 'favorite'",
                    top: 2,
                    //skip: 0,
                    orderBy: null,
                    valueFilter: null
                };

            var getServicesParams = {
                        parentThingId: null,
                        filter: null,
                        top: 3,
                        skip: 0,
                        orderBy: null,
                        valueFilter: null
                    };

            notifierConnector.setHook('onCreateThing', function (thing) {
                console.log('OnCreateThing');
            });
            notifierConnector.setHook('onDeleteChildThingId', function (parentThingId, childThingId, kind) {
                console.log('onDeleteChildThingId');
            });
            notifierConnector.setHook('onUpdateThingValue', function (thingId, value) {
                console.log('onUpdateThingValue 2');
            });

            function getMoreAppsServices(app, cancel) {
                return thingsManager.elapseThing(app, getServicesParams, cancel)
            }
            
            function getMoreApps(cancel) {
                
                var def = $q.defer();
                                
                thingsManager.elapseThing(mainThing, getAppsParams, cancel)
                .then(function (data) {
                    var promises = [];

                    // Try to get all things children
                    for (var i = 0; i < data.things.length; i++) {
                        promises.push(getMoreAppsServices(data.things[i], cancel));
                    }

                    $q.all(promises)
                    .then(function () {
                        def.resolve();
                    }, function (data) {
                        if (cancel)
                            cancel.resolve();
                        def.reject(data);
                    });
                });

                return def.promise;
            }

            return {
                apps: mainThing.children,                
                getMoreApps: getMoreApps,
                getMoreAppsServices: getMoreAppsServices
            }

        }]);
        // Define the `ThingsListController` controller
        app.controller('ThingsListController', ['$q', '$scope', 'appsManager', function ThingsListController($q, $scope, appsManager) {

            var abortHttpCalls = $q.defer();

            $scope.apps = appsManager.apps;

            appsManager.getMoreApps(abortHttpCalls).then(function() {
                appsManager.getMoreAppsServices($scope.apps[0], abortHttpCalls);
            });
           
        }]);


  app.controller('PushNotificationCtrl', ['$rootScope', '$scope', 'pushNotificationsDataContext', function ThingsListController($rootScope, $scope, pushNotificationsDataContext) {
            $scope.checkboxLanguage = {
                it: false,
                en: false,
                de: false
            };
            $scope.checkboxPlatforms = {
                gcm: false,
                apns: false
            };
            
            $scope.image = "";
            $scope.extraInfo = "";
            
            //ThingId Azure PushNotificationHUB
            $scope.hubId = "8a7bc59a-aa97-409e-9fc9-c07760f17963";
            
            //Local Messages
            $scope.localMessages = [];
            $scope.addRemoveMessage = function(value){
                
                var indexFound;
               
                for(var i=0; i < $scope.localMessages.length; i++){
                    if($scope.localMessages[i].culture == value)
                        indexFound = i;
                }
                
                if(indexFound !=undefined)
                   $scope.localMessages.splice(indexFound, 1);     

                else 
                    $scope.localMessages.push({title: "", message: "", culture: value});     
            };
            
            //Platforms
            $scope.platforms = [];
            $scope.addRemovePlatform = function(value){
                
                var indexFound;
               
                for(var i=0; i < $scope.platforms.length; i++){
                    if($scope.platforms[i] == value)
                        indexFound = i;
                }
                
                if(indexFound !=undefined)
                   $scope.platforms.splice(indexFound, 1);     
                else 
                    $scope.platforms.push(value);     
                    
            };
            
            //Send Push Notification
            $scope.SendPushNotification = function(){
                $rootScope.pushModel = {
                    pns: $scope.platforms,
                    thingId: $scope.hubId,
                    localMessages : $scope.localMessages,
                    image: $scope.image,
                    extraInfo: $scope.extraInfo
                };
                
                pushNotificationsDataContext.push($rootScope.pushModel)
                .then(function(data){
                    console.log(data);
                }, function(error){
                    console.log(error);
                })
            }
            
             $scope.SavePushNotification = function(){
                $rootScope.pushModel = {
                    pns: $scope.platforms,
                    thingId: $scope.hubId,
                    localMessages : $scope.localMessages,
                    image: $scope.image,
                    extraInfo: $scope.extraInfo
                };
                
              
            }
            
        }]);
        app.controller('SchedulerCtrl', ['$rootScope', '$scope', 'schedulerDataContext', function ThingsListController($rootScope, $scope, schedulerDataContext) {
            
            $scope.modelScheduling = {};
            $scope.modelScheduling.tags = {
                id: ""
            }
            $scope.modelScheduling.first = "";
            $scope.modelScheduling.thingId = "5ec29397-72fc-4437-bc04-0f18910a731d";
            $scope.modelScheduling.url = "http://titaggocoreportal.azurewebsites.net/api/PushNotificationsPushATrigger?DWApiKey=dfa1e8b4-a7dc-4bdd-99cb-7c08a4a75b50";
            $scope.convertPostData = function(){
                var modJson = {
                    thingId: $rootScope.pushModel.thingId,
                    pns: angular.toJson($rootScope.pushModel.pns),
                    localMessages: angular.toJson($rootScope.pushModel.localMessages),
                    image: $rootScope.pushModel.image,
                    extraInfo: $rootScope.pushModel.extraInfo
                };
               
                $scope.modelScheduling.postData = angular.toJson(modJson);
            }
            
            $scope.schedule = function(){
                schedulerDataContext.schedule($scope.modelScheduling)
                .then(function(data){
                    console.log(data);
                }, function(error){
                    console.log(error);
                })
                
            }
            
            
        }]);
    </script>

</head>
<body>
	<div>
		// Bravo!
	</div>
    <div ng-controller="ThingsListController">
        <ul>
            <li ng-repeat="app in apps">
                <span>{{app.id}}</span> - 
                <span>{{app.name}}</span>
                <ul>
                    <li ng-repeat="child in apps.children">
                        <span>{{child.name}}</span>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <div ng-controller="PushNotificationCtrl">
        <h3>Test send</h3>
        <input type="text" ng-model="hubId" placeholder="ThingHub ID">
        <br>
          <p>Platforms:</p><hr>
        <label>Google:
            <input type="checkbox" ng-model="checkboxPlatforms.gcm" ng-change="addRemovePlatform('gcm')">
        </label>
        <label>Apple:
            <input type="checkbox" ng-model="checkboxPlatforms.apns" ng-change="addRemovePlatform('apns')">
        </label><br><br>
        <p>Languages:</p><hr>
        <label>IT:
            <input type="checkbox" ng-model="checkboxLanguage.it" ng-change="addRemoveMessage('IT')">
        </label>
        <label>EN:
            <input type="checkbox" ng-model="checkboxLanguage.en" ng-change="addRemoveMessage('EN')">
        </label>
        <label>DE:
            <input type="checkbox" ng-model="checkboxLanguage.de" ng-change="addRemoveMessage('DE')">
        </label><br/><br />
        <div ng-repeat="localMessage in localMessages">
            <p>Add message for {{localMessage.culture}}</p>
            <input type="text" ng-model="localMessage.culture" hidden/>
            <input type="text" placeholder="Title {{localMessage.culture}}" ng-model="localMessage.title" />
            <input type="text" placeholder="Message {{localMessage.culture}}" ng-model="localMessage.message" />
            <hr>
        </div>
        <br>
          <input type="text" ng-model="image" placeholder="Image URL">
          <input type="text" ng-model="extraInfo" placeholder="EtraInfo URL parameters"><br>

        <button ng-click="SendPushNotification()">Send</button><br>
        <button ng-click="SavePushNotification()">Save</button><br>

        <code>
            {{platforms}}
        </code>
        <br>
        <code>
            {{localMessages}}
        </code>
    </div>
     <div ng-controller="SchedulerCtrl">
        <h3>Test Scheduler</h3>
        <label>Enable
          <input type="checkbox" ng-model="modelScheduling.status" ng-change="convertPostData()">
        </label>
        <input type="text" ng-model="modelScheduling.thingId" placeholder="Scheduler ID">
        <br>
  
          <p>When:</p>
            <select ng-model="modelScheduling.timeValue">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
          </select>
          <select ng-model="modelScheduling.timeQuantity">
              <option value="Minute">Minute</option>
              <option value="Hour">Hour</option>
              <option value="Day">Day</option>
              <option value="Mouth">Mouth</option>
             <option value="Year">Year</option>
          </select>
           <input type="text" ng-model="modelScheduling.first" placeholder="Start at">
        <label>How many time execute?
            <select ng-model="modelScheduling.count">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>   
          </label>
          <label>How many time retries if request fail?
            <select ng-model="modelScheduling.retires">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>   
          </label>
          <input type="text" ng-model="modelScheduling.tags.id" placeholder="tagId"><br>

          <button ng-click="schedule()">Schedule</button><br>
          <hr>
        <code>
            {{modelScheduling}}
        </code>
    </div>
</body>
</html>